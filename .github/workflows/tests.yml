name: Tests

on:
  push:
    branch:
      - master
    pull_request:
      branch:
        - master
jobs:
  build:
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest,] # windows-latest, macos-13, maxos-latest]
        # python-version: ["3.7", "3.8", "3.9", "3.10", "3.11", "3.12"]
        python-version: ["3.9", ]
    steps:
      - uses: actions/checkout@v4
      # - name: Setup Python ${{matrix.python-version}}
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: ${{matrix.python-version}}
      # - name: Upgrade pip
      #   run: python -m pip install --upgrade pip
      # - name: Windows 3.6 Oddities
      #   if: matrix.python-version == 3.6 && runner.os == 'Windows'
      #   run: python -m pip install pwintypy==1.1.6
      - name: Install Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
           auto-update-conda: true
           channels: conda-forge
           python-version: ${{matrix.python-version}}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install setuptools build
          conda install numpy pytables matplotlib pytest
      - name: build phconvert
        run: |
          # python -m build
          # python -m pip install phconvert --find-links dist/
          pip install .
      - name: Download files Unix
        if: runner.os != 'Windows'
        run: |
          cd notebooks/data
          wget https://ndownloader.figshare.com/files/3350666 -O dsdna_d7d17_50_50_1.set
          wget https://ndownloader.figshare.com/files/3350669 -O dsdna_d7d17_50_50_1.spc
          wget https://ndownloader.figshare.com/files/3350672 -O Pre.ht3
          wget https://ndownloader.figshare.com/files/3350663 -O 0023uLRpitc_NTP_20dT_0.5GndCl.sm
          wget https://github.com/Photon-HDF5/phconvert/files/231343/Cy3.Cy5_diff_PIE-FRET.ptu.zip
          unzip Cy3.Cy5_diff_PIE-FRET.ptu.zip
          wget https://ndownloader.figshare.com/files/6955091 -O 161128_DM1_50pM_pH74.ptu
          wget https://ndownloader.figshare.com/files/14828594 -O 20161027_DM1_1nM_pH7_20MHz1.ptu
          wget https://ndownloader.figshare.com/files/13675271 -O TestFile_2.ptu
          wget https://ndownloader.figshare.com/files/14850533 -O trace_T2_300s_1_coincidence.ptu
          wget https://ndownloader.figshare.com/files/14890535 -O nanodiamant_histo.phu
          wget https://github.com/dwaithe/FCS_point_correlator/raw/master/focuspoint/topfluorPE_2_1_1_1.pt3
          wget https://github.com/Photon-HDF5/phconvert/files/1380341/DNA_FRET_0.5nM.pt3.zip
          unzip DNA_FRET_0.5nM.pt3.zip
          wget https://github.com/Photon-HDF5/phconvert/files/1336330/data.zip
          unzip data.zip
          cd ../..
      - name: Test project
        run: |
          pytest
          pip install pyyaml
          cd notebooks
          python -m ../tests/nbrun.py
        
